{% extends 'base.html' %}
{% block title %}Books{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-xl-10">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="m-0">Books</h1>
      {% if user.is_authenticated and user.role == 'admin' %}
      <form method="post" action="{% url 'delete_filtered_books' %}" class="d-inline">
      {% csrf_token %}
      <input type="hidden" name="title" value="{{ title_query|default:'' }}">
      <input type="hidden" name="author" value="{{ author_query|default:'' }}">
      <input type="hidden" name="category" value="{{ category_id|default:'' }}">
      <input type="hidden" name="availability" value="{{ availability|default:'' }}">
      <input type="hidden" name="min_price" value="{{ min_price|default:'' }}">
      <input type="hidden" name="max_price" value="{{ max_price|default:'' }}">
      <input type="hidden" name="publish_date" value="{{ publish_date|default:'' }}">
      <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete all filtered books?')">Delete Filtered</button>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-12 col-xl-10">
<form method="get" class="row g-3 mb-3 filter-card p-3 border rounded bg-light">
    <!-- Title search -->
    <div class="col-md-3">
        <input type="text" name="title" placeholder="Search by title" value="{{ title_query|default:'' }}" class="form-control">
    </div>

    <!-- Author search -->
    <div class="col-md-3">
        <input type="text" name="author" placeholder="Search by author" value="{{ author_query|default:'' }}" class="form-control">
    </div>

    <!-- Category filter -->
    <div class="col-md-2">
        <select name="category" class="form-select">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if category_id and category_id|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Availability filter -->
    <div class="col-md-2">
        <select name="availability" class="form-select">
            <option value="">All Availability</option>
            <option value="available" {% if availability == 'available' %}selected{% endif %}>Available</option>
            <option value="unavailable" {% if availability == 'unavailable' %}selected{% endif %}>Unavailable</option>
        </select>
    </div>

    <!-- Price range slider -->
    <div class="col-md-4">
        <label class="form-label">Price Range</label>
        <div class="d-flex align-items-center gap-2">
            <input type="range" class="form-range" min="0" max="200" step="1" name="min_price" value="{{ min_price|default:0 }}" oninput="document.getElementById('minPrice').value=this.value">
            <input type="range" class="form-range" min="0" max="200" step="1" name="max_price" value="{{ max_price|default:200 }}" oninput="document.getElementById('maxPrice').value=this.value">
        </div>
        <div class="d-flex justify-content-between align-items-center mt-1">
            <div class="input-group input-group-sm" style="width:180px;">
              <span class="input-group-text">Min $</span>
              <input id="minPrice" type="number" value="{{ min_price|default:0 }}" class="form-control" oninput="document.querySelector('input[name=min_price]').value=this.value">
            </div>
            <div class="input-group input-group-sm" style="width:180px;">
              <span class="input-group-text">Max $</span>
              <input id="maxPrice" type="number" value="{{ max_price|default:200 }}" class="form-control" oninput="document.querySelector('input[name=max_price]').value=this.value">
            </div>
        </div>
    </div>

    <!-- Publish date (exact) -->
    <div class="col-md-2">
        <label class="form-label">Publish date</label>
        <input type="date" name="publish_date" value="{{ publish_date|default:'' }}" class="form-control" placeholder="Publish date">
    </div>

    <!-- Action button: Filter (left) -->
    <div class="col-md-12 mt-2">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </form>
  
  {# admin delete action moved back to header bar #}
  </div>
</div>

{# admin delete action moved to header bar #}

{% if books %}
<div class="row justify-content-center">
  <div class="col-12 col-xl-10">
    <div class="card shadow-sm mt-4 mb-4">
      <div class="card-body p-4">
        <div class="table-responsive">
<table class="table table-striped align-middle mb-0">
    <thead>
        <tr>
            <th>Title</th>
            <th>Authors</th>
            <th>Category</th>
            <th>Publisher</th>
            <th>Price</th>
            <th>Availability</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for book in books %}
        <tr>
            <td>{{ book.title }}</td>
            <td>{{ book.authors.all|join:", " }}</td>
            <td>{% if book.category %}{{ book.category.name }}{% else %}-{% endif %}</td>
            <td>{{ book.publisher.name }}</td>
            <td>${{ book.price }}</td>
            <td>{{ book.availability_status }}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    {% if user.is_authenticated and user.role == 'admin' %}
                        <a href="{% url 'book_edit' book.pk %}" class="btn btn-outline-secondary" title="Edit">Edit</a>
                        <a href="{% url 'book_delete' book.pk %}" class="btn btn-outline-danger" title="Delete">Delete</a>
                    {% endif %}
                    {% if book.id in favorite_ids %}
                        <a href="{% url 'book_favorite_toggle' book.pk %}" class="btn btn-primary" title="Remove from favorites">★</a>
                    {% else %}
                        <a href="{% url 'book_favorite_toggle' book.pk %}" class="btn btn-outline-primary" title="Add to favorites">☆</a>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
        </div>
      </div>
    </div>
  </div>
</div>

{# Pagination removed per request #}

{# Delete button moved next to Filter in the filter bar for admins #}

{% else %}
<p>No books found.</p>
{% endif %}
{% endblock %}
